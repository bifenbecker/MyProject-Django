{% extends 'base.html' %}

{% block custom_head %}

    <!-- Custom styles for this page -->
    <link href="/static/vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
<style>

#show-graph:target {

display: block;

}

#show-graph {

background: rgba(102, 102, 102, 0.68);

width: 100%;

height: 100%;

position: fixed;

top: 0;

left: 0;

display: none;

z-index: 9999999999;

}

window {

position: absolute;

top: 50%;

left: 50%;

width: 400px;

border: 1px solid #cecece;

padding: 50px;

transform: translate(-50%,-50%);

background-color: #fafafa;

}

div#main_text a.close_window {

position: absolute;

right: 10px;

top: 4px;

border: none;

}

</style>
{% endblock %}

{% block content %}

    <div class="row justify-content-center">
        <div class="col-10">
            <h5>Позиции в заказе номер {{ active_order.id }}:</h5>
            <div class="card shadow mb-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered w-100" id="dataTable" cellspacing="0">
                            <thead>
                            <tr>
                                <th>Название</th>
                                <th>Этап</th>
                                <th>Поставщик</th>
                                <th>Ед. измерения</th>
                                <th>Кол-во</th>
                                <th>Цена за единицу</th>
                                <th>Сумма</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for item_to_order in active_order.items_in_order.all %}
                                <tr>
                                    <td>{{ item_to_order.item.name }}</td>
                                    <td>{{ item_to_order.stage.name }}</td>
                                    <td>{{ item_to_order.item.supplier.name }}</td>
                                    <td>{{ item_to_order.item.get_unit_measurement_display }}</td>
                                    <td><input class="form-control" type="number" name="item_qty" min="1" step="1" value="{{ item_to_order.quantity }}" onchange="api_change_item_qty_in_order(this, {{ item_to_order.id }})"></td>
                                    <td><span>{% if item_to_order.price_offer %}{{ item_to_order.price_offer.price_per_unit|floatformat:2 }}{% else %}-{% endif %}</span><span style="float: right"><button onclick="showGraph('{{ item_to_order.item.name }}')" class="btn btn-primary">График</button></span></td>
                                    <td>{% if item_to_order.get_total_price %}{{ item_to_order.get_total_price|floatformat:2 }}{% else %}-{% endif %}</td>
                                    <td>
                                        <button class="btn p-0" onclick="api_remove_item_from_order({{ item_to_order.id }})"><i class="fas fa-trash-alt fa-lg"></i></button>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <a href="{% url 'search_url' %}" class="btn btn-outline-secondary float-right" onclick="api_close_order({{ active_order.id }})">Закрыть заказ</a>
        </div>
    </div>
    <div id="show-graph">
        <window>
           <a href="#close_window" class="close_window">X</a>
            <canvas id="chart" width="500" height="500"></canvas>
        </window>
    </div>
{% endblock %}

{% block custom_script %}

    <!-- Page level plugins -->
    <script src="/static/vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="/static/vendor/datatables/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>
    <script>

        function showGraph(name){
            location.hash ='show-graph'
            var price_history_str = "{{ price_history }}".replace(/&#x27;/g,"\"").replace(/&quot;/g,"\"")
            
            var obj_str = price_history_str.substr(1, price_history_str.length - 3)
            var objs = obj_str.split("}, ")

            var _labels = []
            var _data = []
            for(var i = 0; i < objs.length; i++){
                item_name = objs[i].split(": {")[0].replace(/^ '|^"|'$|"$/g,'')
                
                if(item_name == name){
                    var b = objs[i].split(": {")[1].split(", ")
                        for(var j = 0; j < b.length; j++){
                            _labels.push(b[j].split(": ")[0].split(" ")[0].replace("\"",""))
                            if(b[j].split(": ")[1] !== "None"){
                                _data.push(b[j].split(": ")[1])
                            }
                    
                        }
                }
                
            }
            const data = {
                labels: _labels,
                datasets: [{
                    label: 'Цена',
                    data: _data,
                    fill: true,
                    borderColor: 'rgb(0, 204, 0)',
                    backgroundColor: 'rgb(0, 102, 255, 0.5)',
                    tension: 0.1
                }]
            };
            const config = {
                type: 'line',
                data: data,
            };
            let ctx = document.getElementById("chart");
            let chart = new Chart(ctx, config);
        }

        $(document).ready(function() {
            $('#dataTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Russian.json",
                },
                "paging": false,
                "searching": false
            });
        });
            
    </script>

    <!-- /.container-fluid -->
{% endblock %}